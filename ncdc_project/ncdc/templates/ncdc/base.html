{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}NCDC{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'ncdc/css/base.css' %}">
    <link rel="shortcut icon" href="{% static 'ncdc/images/favicon.ico' %} " type="image/x-icon">
    {% block extra_css %}{% endblock %}
</head>
<body>
<!-- Navbar -->
<header>
    <nav class="navbar">
        <img src="{% static 'ncdc/images/Logo.png' %}" alt="logo-image" style="width:100px;height:60px;margin:10px;">
        <ul class="nav-menu">
            <li><a href="{% url 'home'%}">Home</a></li>
            <li class="dropdown">
                <a href="#" class="dropbtn">About</a>
                <div class="dropdown-content">
                    <a href="{% url 'about' %}">NCDC</a>
                    <a href="{% url 'departments' %}">Department</a>
                    <a href="{% url 'leadership' %}">Leadership</a>
                    <a href="{% url 'office_of_dg' %}">Office of the DG</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="#">Publications</a>
                <div class="dropdown-content">
                    <a href="{% url 'weekly_reports' %}">Weekly Epidemiological Report</a>
                    <a href="{% url 'situation_report_list' %}">Situation Reports</a>
                    <a href="{% url 'project_reports' %}">Project Reports</a>
                    <a href="{% url 'annual_reports' %}">Annual Reports</a>
                    <a href="{% url 'guidelines_list' %}">Guidelines/Protocols</a>
                    <a href="{% url 'establishment_documents_list' %}">Establishment/Guiding Documents</a>
                    <a href="{% url 'research_list' %}">Research</a>
                    <a href="{% url 'state_incident_action_plans' %}">State Incident Action Plans</a>
                </div>
            </li>

            <li class="dropdown">
                <a href="#" class="dropbtn">Diseases</a>
                <div class="dropdown-content">
                    <a href="{% url 'disease_list' %}">A-Z</a>
                </div>
            </li>
            <li><a href="{% url 'news_home' %}">News</a></li>
            <li class="dropdown">
                <a href="#" class="dropbtn">Training</a>
                <div class="dropdown-content">
                    <a href="{% url 'nfetp'%}">NFELTP</a>
                    <a href="{% url 'internship' %}">INTERNSHIP</a>
                    <a href="{% url 'ncdc_tour' %}">TOUR</a>
                </div>
            </li>
            <li class="dropdown">
                <a href="#">Projects</a>
                <div>
                    <a href="{% url 'project_list' %}">Projects</a>
                    <a href="{% url '' %}">SRAMF</a>
                </div>
            </li>
            <li><a href="#">Jobs</a></li>
            <li><a href="#">Dashboard</a></li>
            <li><a href="#">e-Learning</a></li>
            <li><a href="#">Contact</a></li>
            <li><a href="#">Library</a></li>
            <li class="dropdown">
                <a href="#" class="dropbtn">Videos</a>
                <div class="dropdown-content">
                    <a href="video1.html">Video 1</a>
                    <a href="video2.html">Video 2</a>
                </div>
            </li>
        </ul>
        <div class="hamburger" onclick="toggleMenu()">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </nav>
</header>
<!-- Main Content -->
<main>
    {% block content %}{% endblock %}
</main>


<!-- AI Chatbot Icon and Chatbox -->
<div id="chatbot-icon" onclick="toggleChatbot()">
    <img src="{% static 'ncdc/images/aichat.png' %}" alt="AI Chatbot" style="width:50px; height:50px; radius:5px;"/>
</div>

<div class="chatbot-hidden" id="chatbot-box" style="display:none">
    <div class="chatbot-header">
        <span>Chat with NCDC AI</span>
        <button onclick="toggleChatbot()">Ã—</button>
    </div>
    <div id="chatbot-content" class="chatbot-content">
        <div id="chatbot-messages"></div>
    </div>
    <div class="chatbot-input">
        {% csrf_token %}
        <input type="text" id="chatbot-input-field" placeholder="Ask me anything about diseases"
               onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<!-- HTML -->
<footer class="footer">
    <div class="footer-main">
        <div class="footer-section">
            <h2 class="footer-heading">Contacts</h2>
            <div class="contact-info">
                <p><i class="location-icon"></i> Plot 801, Ebitu Ukiwe Street, Jabi, Abuja, Nigeria</p>
                <p><i class="phone-icon"></i> 6232 (Toll-Free Call Centre)</p>
                <p><i class="email-icon"></i> info@ncdc.gov.ng</p>
            </div>
        </div>

        <div class="footer-section">
            <h2 class="footer-heading">Social Media</h2>
            <div class="social-links">
                <p><i class="facebook-icon"></i> @NCDCgov</p>
                <p><i class="twitter-icon"></i> @NCDCgov</p>
                <p><i class="youtube-icon"></i> NCDC</p>
                <p><i class="instagram-icon"></i> NCDCgov</p>
                <p><i class="telegram-icon"></i> t.me/NCDCgov (Telegram)</p>
            </div>
            <a href="#" class="newsletter-btn">Subscribe to Newsletter</a>
        </div>

        <div class="footer-section">
            <h2 class="footer-heading">Mandate of NCDC</h2>
            <p class="mandate-text">
                The Nigeria Centre for Disease Control and Prevention (NCDC) was established in the year 2011 in
                response to the challenges of public health emergencies and to enhance Nigeria's preparedness and
                response to epidemics through prevention, detection and control of communicable diseases.
            </p>
            <a href="#" class="terms-link">Terms and Conditions</a>
        </div>
    </div>

    <div class="connect-centre">
        <h2 class="connect-heading">Connect Centre</h2>
        <div class="connect-info">
            <div class="connect-item">
                <i class="phone-icon"></i>
                <span>Toll Free Number: 6232</span>
            </div>
            <div class="connect-item">
                <i class="whatsapp-icon"></i>
                <span>Whatsapp: +234 708 711 0839</span>
            </div>
            <div class="connect-item">
                <i class="sms-icon"></i>
                <span>SMS Number: +234 809 955 5577</span>
            </div>
        </div>
        <p style="text-align:center;">&copy; {{ current_year }} Nigeria Centre for Disease Control. All rights
            reserved.</p>
    </div>
</footer>

<script>
    function toggleMenu() {
    const navMenu = document.querySelector(".nav-menu");
    navMenu.classList.toggle("active");
    }

    // Toggle the chatbot visibility
    function toggleChatbot() {
        const chatbotBox = document.getElementById("chatbot-box");

        // Check the current display property and toggle it
        if (chatbotBox.style.display === "block") {
            chatbotBox.style.display = "none"; // Hide the chatbot
        } else {
            chatbotBox.style.display = "block"; // Show the chatbot
        }
    }


// Handle Enter key press to send message
function handleKeyPress(event) {
    if (event.key === "Enter") {
        sendMessage();
    }
}

// Send user message to the API
async function sendMessage() {
    const inputField = document.getElementById("chatbot-input-field");
    const message = inputField.value.trim();

    if (message === "") return;

    // Display user message
    displayMessage(message, "user");
    inputField.value = "";

    try {
        const csrfToken = getCsrfToken();

        // Send message to the backend
        const response = await fetch("/chatbot-api/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify({ message: message })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data && data.reply) {
            displayMessage(data.reply, "bot");
        } else {
            displayMessage("Sorry, I didn't understand that.", "bot");
        }
    } catch (error) {
        displayMessage("Sorry, I couldn't connect to the AI server.", "bot");
        console.error("Error:", error);
    }
}

// Display message in the chat
function displayMessage(text, sender) {
    const messagesContainer = document.getElementById("chatbot-messages");
    const messageElement = document.createElement("div");
    messageElement.classList.add("chatbot-message", sender);
    messageElement.textContent = text;
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to the latest message
}

// Utility function to retrieve CSRF token
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    if (!csrfToken) {
        console.error("CSRF token not found. Ensure your HTML includes a CSRF token.");
    }
    return csrfToken;
}

// Function to handle location alerts
document.addEventListener("DOMContentLoaded", () => {
    if (navigator.geolocation) {
        // Check if the location permission is already granted or prompt
        navigator.permissions.query({ name: "geolocation" }).then((result) => {
            if (result.state === "granted" || result.state === "prompt") {
                // Retrieve location on page load
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        sendLocationToServer(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        alert("Unable to access location. Location access is required for personalized alerts.");
                    }
                );
            } else {
                alert("Location access is required for personalized alerts.");
            }
        });
    } else {
        alert("Geolocation is not supported by your browser.");
    }
});

function sendLocationToServer(lat, lng) {
    fetch("/update-location/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
        },
        body: JSON.stringify({ latitude: lat, longitude: lng }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.alert) {
                alert(data.alert); // Display the outbreak alert
            } else {
                alert("There are no current disease outbreaks in your area."); // Alert if no outbreaks
            }
        })
        .catch((error) => console.error("Error sending location:", error));
}

// Utility function to retrieve CSRF token
function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    if (!csrfToken) {
        console.error("CSRF token not found. Ensure your HTML includes a CSRF token.");
    }
    return csrfToken;
}

</script>
{% block extra_js %}{% endblock %}
</body>
</html>
